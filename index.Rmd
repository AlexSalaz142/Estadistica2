---
title: "index"
output: html_document
date: '2022-10-30'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

La siguiente investigación analiza los factores que pueden profundizar la desigualdad de ingreso en la sociedad. Aquí se analizarán tres posibles tipos de factores; laborales, sociales y económicos.  El factor social será medido a través del nivel de democratización, población urbana, embarazo adolescente, matrícula escolar y mortalidad; el factor laboral se mide a través de la tasa de desempleo y fuerza de trabajo, y el factor económico por medio del nivel de exportaciones y gasto en educación. 

```{r}
library(rio)
datafinal=import("https://github.com/AlexSalaz142/TrabajoE2/raw/main/datafinal.csv")
```

## 1. Análisis rápido de la data

A primera vista, se puede ver como países con un nivel de desempleo medianamente alto también presentan un nivel medinamente alto de desigualdad económica, como es el caso de Eswatini, Botswana o Lesotho. Por otra parte, países con un alto índice de la democracia como Noruega, Islanda, Suiza o Finlandia presentan niveles de desigualdad reducidas. Finalmente, parecería no haber relación entre la desigualdad y el gasto en educación ya que países con una inversión menor como Angola o Papua Nueva Guinea muestran una desigualdad de ingreso similar a paises con gastos mayores como Costa Rica o Hong Kong. No obstante, estas son primeras impresiones que resultan poco confiables en tanto seleccionamos casos que respaldan nuestras hipótesis y por lo tanto deben ser confirmadas por un análisis de correlaciones. 

En la introducción identificamos tres tipos de factores. Sin embargo, lo particular de estas variables presentadas es que pueden evaluarse de forma transversal (como es el caso del gasto en educación que tiene tanto una afectación social como una explicación económica), por lo que un análisis factorial nos permitirá confirmar a que área se acerca más cada variable.

## 2. Modelación
En este caso, se realizará una regresión lineal múltiple.

Modelo 1: 
Índice de desigualdad del ingreso = b0 + b1*Tasa de desempleo

```{r}
Modelrl=lm(gini~Unemployment, datafinal)
anova(Modelrl)
summary(Modelrl)
```
    
    gini = 34.3195 + 0.4862 * (Unemployment)

Podemos evidenciar que, en principio, se evidencia una relación estadísticamente significativa, por lo cual la variable de desempleo presentaría una correlación directa con la variable de desigualdad del ingreso. Esto básicamente indicaría que un país con mayor tasa de desemplo tiene mayor probabilidad de presentar una desigualdad económica más profunda.

Modelo 2: 
Índice de desigualdad del ingreso = b0 + b1 * Tasa de desempleo + b2 * Índice de democracia

```{r}
Modelrl2=lm(gini~Unemployment+DemoIndex, datafinal)
anova(Modelrl2)
summary(Modelrl2)
```

    gini = 39.9099 + 0.5469 * (Unemployment) + -1.0117 * (DemoIndex)

Haber añadido el índice de democracia no ha alterado la significancia de la tasa de desempleo para el modelo. Por otro lado, el R Ajustado ha aumentado en un 0.0672, lo cual no es realmente mucho, mas indicaría que vamos por un buen camino. Además, a diferencia de la caso anterior, en este caso se expresaría una relación inversamente proporcional entre la desigualdad de ingreso y el índice de democracia. Esto implicaría que mientras un país se considere más democrático tiene más probabilidades de presentar menor desigualdad.

Modelo 3: 
Índice de desigualdad del ingreso = b0 + b1 * Tasa de desempleo + b2 * Índice de democracia + b3 * Porcentaje de gasto público en educación

```{r}
Modelrl3=lm(gini~Unemployment+DemoIndex+EducationExpenditure, datafinal)
anova(Modelrl3)
summary(Modelrl3)
```
    
    gini = 34.5966 + 0.5545 * (Unemployment) + -0.9296 * (DemoIndex) + 0.3269 * (Education expenditure)

El modelo 3 explica el coeficiente de GINI (Y) en un 21% a partir de las variables independientes del porcentaje de desempleo (Unemployment), el índice de la democracia (DemoIndex) y el porcentaje de gasto en educación (Education expenditure). Sin embargo, un 21% de variación no es especialmente útil para la extrapolación final de los resultados a la realidad, cosa que se arreglaría con la inclusión de las demás variables.

Podemos notar como 2 de las 3 variables independientes resultan significativas (el porcentaje de gasto en educación no resulta significante). Entonces, a pesar de que el modelo en general sea más exacto que los anteriores 2, la inclusión de esta tercera variable ha reducido la afectación de las demás.

Ahora, para evidenciar clararamente cuál es la variable de mayor efecto sobre la variable dependiente, podemos estandarizarlas:

```{r}
library(lm.beta)
lm.beta(Modelrl3)
```
Esto nos muestra que definitivamente la variable de desempleo es la variable con mayor peso para el modelo.

Podemos igualmente comparar estos tres primeros modelos gráficamente:
```{r}
library(stargazer)
library(jtools)
stargazer(Modelrl,Modelrl2,Modelrl3, type ="text")
plot_summs(Modelrl,Modelrl2,Modelrl3, scale = TRUE)
```

Realizar otra regresión con las otras variables independientes:

Modelo 4:
```{r}
Modelrl4=lm(gini~urb_pop+exports+school_enr, datafinal)
anova(Modelrl4)
summary(Modelrl4)
```
El modelo explica la desigualdad en la distribución de los ingresos (coeficiente de Gini) con un R2 Ajustado de 0.1013, lo cual podría explicar la variable dependiente pero no resulta lo suficientemente significativo como para concluir que es de gran relevancia.

La variable tasa de matricula escolar (school_enr), es la que más influye en el modelo, pues tiene un valor de 0.01046 y presenta un asterisco. Por otro lado, las variables porcentaje de población urbana (urb_pop) y porcentaje de exportación de metales y minerales (exports) son las que menos aportan al modelo al tener mayor valor y no estar determinadas por un asterisco.

Modelo 5:
```{r}
Modelrl5=lm(gini~teen_preg+death_rate+labor_force, datafinal)
anova(Modelrl5)
summary(Modelrl5)
```
El modelo explica la desigualdad en la distribución de los ingresos (coeficiente de Gini) con un R2 Ajustado de 0.3638, lo cual parece tener una cierta relevancia.
La variable fertilidad adolescente (teen_preg), es la que más influye en el modelo, pues tiene un valor de 3.952e-10 y presenta tres asteriscos, por lo cual está bien relacionada a la variable dependiente. La variable mortalidad (death_rate) presenta también cierta significancia pues está acompañada de un asterisco y un  valor de 0.02966. Por último, la variable fuerza laboral es la que menos aporta al modelo.

Regresión final - Modelo 6:
```{r}
Modelrl6=lm(gini~Unemployment+DemoIndex+EducationExpenditure+urb_pop+exports+school_enr+teen_preg+death_rate+labor_force, datafinal)
anova(Modelrl6)
summary(Modelrl6)
```
   
    gini = 13.395737 + 0.571798 * (Unemployment) -0.020243 * (DemoIndex) + 0.055099 * (Education expenditure) + 0.028412 * (urb_pop) -0.004342 * (exports) + 0.101183 * (school_enr) + 0.108677 * (teen_preg) -0.541102 * (death_rate) + 0.095891 * (labor_force)

El modelo 6 reune todas las variables contempladas para la predicción de la desigualdad del ingreso. 
Se presenta un R ajustado de un 0.5192, superior al de todos los anteriores modelos, por lo que ya debería considerarse a priori como el modelo más adecuado. No obstante, hay que tener en cuenta algunas aristas.

En primer lugar, solo 3 de las 9 variables se identificarían como estadísticamente significantes. Estas son el desempleo, el embarazo adolescente y la mortalidad. Además, se ha perdido el aporte de la variable de desemplo, que en el tercer modelo era significante. A pesar de las aparentes inconveniencias, hay que reconocer que las otras 5 variables no mencionadas desde un principio no presentan un aporte significativo para la explicación de la desigualdad económica. 

Vamos a estandarizar las variables para revisar la afectación:
```{r}
lm.beta(Modelrl6)
```
De esta manera, se identifica al embarazo adolescente como la variable con mayor efecto sobre la desigualdad de ingreso.

En segundo lugar, se evidencia que, en base al signo de los coeficientes, la relación del desempleo y el embarazo adolescente con la desigualdad de ingreso es directamente proporcional, mientras que la la relación de la mortalidad con la desigualdad es inversamente proporcional.

Finalmente, podemos establecer 3 correlaciones fuertes o medianamente fuertes, por lo cual se puede afirmar que la desigualdad de ingreso se explica por el desempleo, el embarazo adolescente y la mortalidad. Esto significa que, cuando un país presenta una mayor tasa de desempleo y de embarazo adolescente, es más probable que dicho país observe una mayor desigualdad del ingreso en relación con los demás países con tasas menores. Por la otra parte, mientras un país presente una mayor tasa de mortalidad, hay más posibilidades de que tal observe una menor desigualdad. 

Graficamos para compararlo con los 3 principales modelos:
```{r}
stargazer(Modelrl3, Modelrl4, Modelrl5, Modelrl6, type ="text")
plot_summs(Modelrl3, Modelrl4, Modelrl5, Modelrl6, scale = TRUE)
```

Vemos como los intervalos de mortalidad, embarazo adolescente y desemplo son las únicos que no cruzan por el 0, lo que explica la significancia.

A partir de todo esto, concluimos que la tesis de que una alta tasa de mortalidad implica ingresos menos desiguales debe ser rechazada. Es cierto que si existe una menor tasa de mortalidad existirá mayor cantidad de gente que pueda generar más ingresos, pero habría que identificar en qué grupos de edad se focaliza la mortilidad, puesto que, dependiendo de la edad, una persona percibe más o menos ingresos o no los recibe en absoluto. En ese sentido, por muy cínico que suene, habría que el fallecimiento de unas personas afecta en mayor medida al ingreso familiar que el de otras. Un objetivo posterior consistiría por tanto en descubrir que características de la persona determinan esta afectación.

Por su parte, la hipótesis de que el embarazo adolescente implica mayor desigualdad puede considerarse como correcta. El caso es que, las adolescentes que quedan embarazadas encuentran complicaciones con el seguimiento de estudios, lo que a su vez implica una limitación a la empleabilidad. Además, en tanto un hij@ acarrea consigo un aumento a los gastos familiares, por lo que el ingreso neto percibido será menor. 

Por último, el argumento de que la afectación del desempleo en la desigualdad del ingreso debería considerarse de manera sistemática debe no ser rechazado, pero si cuestionarse. Si por el contrario el modelo hubiese arrojado que no existía una correlación entre estas variables, ello podría interpretarse como que el nivel de desarrollo entendido en términos de estabilidad laboral o no se relaciona con la desigualdad económica, o no se evidencia en la realidad. Dado que ese no es el caso, es más fácil suponer que los países con menores tasas de desempleo (que en su mayoría se tratan de países desarrollados) son menos desiguales. Pero, consideramos que no hay que caer en el error de imponerla como una variable causal, pues el análisis de correlación no toma en cuenta  la relación con las otras variables como la democratización, lo cual se intentará resolver adelante con el análisi facotiral.


## 3. Análisis factorial

3.1. Anális factorial exploratorio:

Primero substeamos la data para quedarnos con las variables de interés:
```{r}
dontselect=c("country","gini")
select=setdiff(names(datafinal),dontselect) 
theData=datafinal[,select]
```

Calculamos la matriz de correlación 
```{r}
library(polycor)
corMatrix=polycor::hetcor(theData)$correlations
```

Visibilizamos el nivel de correlación:
```{r}
library(ggcorrplot)
ggcorrplot(corMatrix)
```
Con este gráfico se visualiza que la formación de factores no es del todo clara, pero podría intuirse la agrupación de variables como la tasa de mortalidad, la fuerza laboral y el desempleo.

Igualmente es imprescindible verificar si las datos permiten la factorización:
```{r}
library(psych)
psych::KMO(corMatrix) 
```
El MSA (medida de suficiencia de la muestra) general (0.55) resulta despreciable (>= 0.50), por lo cual no llega a ser del todo conveniente el análisis factorial.

De todas formas seguiremos el procedimiento, para observar el resultado final.

Se verifica si la matriz de correlación es adecuada, rechazando nuestras 2 hipótesis nulas:

H1: Se trata de una matriz de identidad (Esfericidad de Bartlett):
```{r}
cortest.bartlett(corMatrix,n=nrow(theData))$p.value>0.05
```
H2: Se trata de una matriz singular: 
```{r}
library(matrixcalc)
is.singular.matrix(corMatrix)
```
Confirmamos que no nos encontramos ante una matriz que lleve a la indeterminación, por lo que el análisis factorial es factible. 

Buscamos que R nos sugiera en cuántos factores se puede redimensionar la data:
```{r}
fa.parallel(theData, fa = 'fa',correct = T,plot = F)
```
Lamentablemente, se sugiere la creación de una sola variable latente, lo cual no nos lleva a resultados tan interesantes. Esto sucede porque porque varias de las variables independientes apenas presentan una MSA superior a 0.50, con lo cual se alejan bastante de una relación ideal teniendo en cuenta que incluso un MSA inferior a 0.70 es mediocre.

De acuerdo al resultado anterior, redimensionamos la data:
```{r}
library(GPArotation)
resfa <- fa(theData,
            nfactors = 1,
            cor = 'mixed',
            rotate = "varimax",
            fm="minres")
print(resfa$loadings)
```
La agrupación se visibiliza con mayor claridad en el siguiente gráfico:
```{r}
fa.diagram(resfa,main = "Resultados del EFA")
```
De ello se saca que el índice de democracia, el porcentaje de población urbana, el embarazo adolescente, el porcentaje de gasto en educación y la tasa de mortalidad se agrupan en un factor, el cual podríamos considerar como el factor social. 

Evaluamos el aporte de las variables al único factor:
```{r}
sort(resfa$communality)
```
De esto se concluye que el índice de la democracia es el que contribuye más a la formación del factor.
